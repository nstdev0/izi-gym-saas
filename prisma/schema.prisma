generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Attendance {
  id             String           @id @default(cuid())
  date           DateTime         @default(now())
  method         AttendanceMethod @default(QR)
  memberId       String
  organizationId String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  deletedAt      DateTime?
  isActive       Boolean          @default(true)
  member         Member           @relation(fields: [memberId], references: [id])
  organization   Organization     @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([memberId])
  @@index([date])
}

model Invoice {
  id             String         @id @default(cuid())
  prefix         String?
  number         Int
  fullNumber     String
  organizationId String
  memberId       String
  currency       String         @default("PEN")
  subtotal       Decimal        @db.Decimal(10, 2)
  taxRate        Decimal        @default(0) @db.Decimal(5, 2)
  taxAmount      Decimal        @db.Decimal(10, 2)
  discount       Decimal        @default(0) @db.Decimal(10, 2)
  total          Decimal        @db.Decimal(10, 2)
  status         InvoiceStatus  @default(DRAFT)
  paymentMethod  PaymentMethod?
  issuedAt       DateTime       @default(now())
  dueAt          DateTime       @default(now())
  paidAt         DateTime?
  voidedAt       DateTime?
  pdfUrl         String?
  notes          String?
  internalNotes  String?
  deletedAt      DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  member         Member         @relation(fields: [memberId], references: [id])
  organization   Organization   @relation(fields: [organizationId], references: [id])
  items          InvoiceItem[]

  @@unique([organizationId, fullNumber])
  @@index([memberId])
  @@index([issuedAt])
  @@index([status])
}

model InvoiceItem {
  id          String    @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int       @default(1)
  unitPrice   Decimal   @db.Decimal(10, 2)
  subtotal    Decimal   @db.Decimal(10, 2)
  productId   String?
  planId      String?
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  plan        Plan?     @relation(fields: [planId], references: [id])
  product     Product?  @relation(fields: [productId], references: [id])
}

model Member {
  id             String       @id @default(cuid())
  firstName      String
  lastName       String
  email          String?
  phone          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  docNumber      String
  birthDate      DateTime?    @db.Date
  docType        DocType
  gender         Gender?
  organizationId String
  isActive       Boolean      @default(true)
  height         Float?
  image          String?
  imc            Float?
  weight         Float?
  deletedAt      DateTime?
  qr             String
  status         EntityStatus @default(ACTIVE)
  attendances    Attendance[]
  invoices       Invoice[]
  organization   Organization @relation(fields: [organizationId], references: [id])
  memberships    Membership[]

  @@unique([qr, organizationId])
  @@unique([docType, docNumber, organizationId])
  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([lastName, firstName])
}

model Membership {
  id             String           @id @default(cuid())
  startDate      DateTime
  endDate        DateTime
  status         MembershipStatus @default(PENDING)
  pricePaid      Decimal          @db.Decimal(10, 2)
  memberId       String
  planId         String
  organizationId String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  deletedAt      DateTime?
  isActive       Boolean          @default(true)
  member         Member           @relation(fields: [memberId], references: [id])
  organization   Organization     @relation(fields: [organizationId], references: [id])
  plan           Plan             @relation(fields: [planId], references: [id])

  @@index([organizationId])
  @@index([memberId])
  @@index([status])
  @@index([endDate])
}

model Organization {
  id                 String              @id @default(cuid())
  name               String              @unique
  slug               String              @unique
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  image              String?
  organizationPlanId String
  deletedAt          DateTime?
  organizationPlan   String
  organizationId     String              @unique
  status             Boolean             @default(true)
  storageUsed        BigInt              @default(0)
  attendances        Attendance[]
  invoices           Invoice[]
  members            Member[]
  memberships        Membership[]
  plan               OrganizationPlan    @relation(fields: [organizationPlanId, organizationPlan], references: [id, name])
  config             OrganizationConfig?
  plans              Plan[]              @relation("GymPlans")
  products           Product[]
  subscription       Subscription?
  users              User[]
  apiKeys            ApiKey[]
}

model ApiKey {
  id             String       @id @default(cuid())
  name           String
  keyHash        String       @unique
  scopes         String[]
  organizationId String
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([keyHash])
}

model OrganizationConfig {
  id             String       @id @default(cuid())
  organizationId String       @unique
  locale         String       @default("es-PE")
  timezone       String       @default("America/Lima")
  currency       String       @default("PEN")
  branding       Json?
  billing        Json?
  booking        Json?
  accessControl  Json?
  notifications  Json?
  features       Json?
  staffSettings  Json?
  deletedAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  identity       Json?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model OrganizationPlan {
  id            String         @id @default(cuid())
  name          String         @unique
  slug          String         @unique
  description   String?
  image         String?
  price         Decimal        @default(0) @db.Decimal(10, 2)
  currency      String         @default("USD")
  interval      PlanInterval   @default(MONTH)
  limits        Json
  stripePriceId String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  isActive      Boolean        @default(true)
  organizations Organization[]
  subscriptions Subscription[]

  @@unique([id, name])
}

model Plan {
  id             String        @id @default(cuid())
  name           String        @unique
  description    String?
  price          Decimal       @db.Decimal(10, 2)
  durationDays   Int
  organizationId String
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  image          String?
  deletedAt      DateTime?
  status         EntityStatus  @default(ACTIVE)
  slug           String        @unique
  invoiceItems   InvoiceItem[]
  memberships    Membership[]
  organization   Organization  @relation("GymPlans", fields: [organizationId], references: [id])

  @@unique([organizationId, name])
  @@index([organizationId])
}

model Product {
  id             String        @id @default(cuid())
  sku            String?
  name           String
  description    String?
  price          Decimal       @db.Decimal(10, 2)
  cost           Decimal       @db.Decimal(10, 2)
  stock          Int           @default(0)
  minStock       Int           @default(5)
  type           ProductType
  isActive       Boolean       @default(true)
  organizationId String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  images         String[]
  deletedAt      DateTime?
  status         EntityStatus  @default(ACTIVE)
  invoiceItems   InvoiceItem[]
  organization   Organization  @relation(fields: [organizationId], references: [id])

  @@unique([sku, organizationId])
  @@unique([name, organizationId])
  @@index([organizationId])
}

model Subscription {
  id                   String             @id @default(cuid())
  organizationId       String             @unique
  organizationPlanId   String
  stripeCustomerId     String?
  stripeSubscriptionId String?            @unique
  status               SubscriptionStatus
  currentPeriodStart   DateTime           @default(now())
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  deletedAt            DateTime?
  pricePaid            Decimal            @db.Decimal(10, 2)
  organization         Organization       @relation(fields: [organizationId], references: [id])
  plan                 OrganizationPlan   @relation(fields: [organizationPlanId], references: [id])
}

model SystemConfig {
  id                 String    @id @default(cuid())
  maintenanceMode    Boolean   @default(false)
  globalAnnouncement String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  deletedAt          DateTime?
}

model User {
  id             String        @id @default(cuid())
  email          String
  passwordHash   String?
  role           Role          @default(STAFF)
  organizationId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  image          String?
  isActive       Boolean       @default(true)
  firstName      String?
  lastName       String?
  deletedAt      DateTime?
  preferences    Json?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@unique([email, organizationId])
  @@index([organizationId])
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  INCOMPLETE
}

enum Role {
  GOD
  OWNER
  ADMIN
  STAFF
  TRAINER
}

enum DocType {
  DNI
  CE
  PASSPORT
  RUC
}

enum Gender {
  MALE
  FEMALE
}

enum ProductType {
  CONSUMABLE
  GEAR
  MERCH
  SERVICE
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
  PENDING
  CANCELLED
}

enum AttendanceMethod {
  QR
  MANUAL
}

enum EntityStatus {
  ACTIVE
  INACTIVE
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  VOID
  OVERDUE
  REFUNDED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  TRANSFER
  YAPE
  PLIN
  STRIPE
}

enum PlanInterval {
  MONTH
  YEAR
}
