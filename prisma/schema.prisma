generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --------------------------------------
// MODELS
// --------------------------------------

model Attendance {
  id     String           @id @default(cuid())
  date   DateTime         @default(now())
  method AttendanceMethod @default(QR)

  memberId String
  member   Member @relation(fields: [memberId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([organizationId])
  @@index([memberId])
  @@index([date])
}

model Invoice {
  id String @id @default(cuid())

  // Numeración
  prefix     String?
  number     Int
  fullNumber String

  // Relaciones
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  memberId String
  member   Member @relation(fields: [memberId], references: [id])

  // Financiero
  currency  String  @default("PEN")
  subtotal  Decimal @db.Decimal(10, 2)
  taxRate   Decimal @default(0) @db.Decimal(5, 2)
  taxAmount Decimal @db.Decimal(10, 2)
  discount  Decimal @default(0) @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)

  // Estado
  status        InvoiceStatus  @default(DRAFT)
  paymentMethod PaymentMethod?

  issuedAt DateTime  @default(now())
  dueAt    DateTime  @default(now())
  paidAt   DateTime?
  voidedAt DateTime?

  // Notas
  pdfUrl        String?
  notes         String?
  internalNotes String?

  items InvoiceItem[]

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Unicidad compuesta: El número de factura no se repite dentro del mismo gym
  @@unique([organizationId, fullNumber])
  @@index([memberId])
  @@index([issuedAt])
  @@index([status])
}

model InvoiceItem {
  id String @id @default(cuid())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  subtotal    Decimal @db.Decimal(10, 2)

  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  planId String?
  plan   Plan?   @relation(fields: [planId], references: [id])

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Member {
  id String @id @default(cuid())

  // CAMBIO: 'qr' ya no es @unique globalmente aquí
  qr String

  firstName String
  lastName  String
  image     String?
  email     String?
  phone     String?
  docNumber String
  docType   DocType
  birthDate DateTime? @db.Date
  gender    Gender?
  height    Float?
  weight    Float?
  imc       Float?

  status EntityStatus @default(ACTIVE)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  memberships Membership[]
  attendances Attendance[]
  invoices    Invoice[]

  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // REGLAS APLICADAS:
  // 1. QR único por organización
  @@unique([qr, organizationId])
  // 2. Documento único por organización
  @@unique([docType, docNumber, organizationId])
  // 3. Email único por organización
  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([lastName, firstName])
}

model Membership {
  id        String           @id @default(cuid())
  startDate DateTime
  endDate   DateTime
  status    MembershipStatus @default(PENDING)
  pricePaid Decimal          @db.Decimal(10, 2)

  memberId String
  member   Member @relation(fields: [memberId], references: [id])

  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([organizationId])
  @@index([memberId])
  @@index([status])
  @@index([endDate])
}

model Organization {
  id             String @id @default(cuid())
  organizationId String

  // REGLA APLICADA: Name y Slug únicos globales
  name  String  @unique
  slug  String  @unique
  image String?

  organizationPlanId String
  organizationPlan   String
  plan               OrganizationPlan @relation(fields: [organizationPlanId, organizationPlan], references: [id, name])

  config OrganizationConfig?

  members     Member[]
  memberships Membership[]
  plans       Plan[]       @relation("GymPlans")
  products    Product[]
  users       User[]
  attendances Attendance[]
  invoices    Invoice[]

  subscription Subscription?

  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model OrganizationConfig {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  locale   String @default("es-PE")
  timezone String @default("America/Lima")
  currency String @default("PEN")

  identity      Json?
  branding      Json?
  billing       Json?
  booking       Json?
  accessControl Json?
  notifications Json?
  features      Json?
  staffSettings Json?

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model OrganizationPlan {
  id String @id @default(cuid())

  // REGLA APLICADA: Name y Slug únicos globales
  name String @unique
  slug String @unique

  description   String?
  image         String?
  price         Decimal @default(0) @db.Decimal(10, 2)
  currency      String  @default("USD")
  limits        Json
  stripePriceId String?

  organizations Organization[]
  subscriptions Subscription[]

  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([id, name])
}

model Plan {
  id           String       @id @default(cuid())
  name         String       @unique
  slug         String       @unique
  description  String?
  price        Decimal      @db.Decimal(10, 2)
  durationDays Int
  status       EntityStatus @default(ACTIVE)
  image        String?

  organizationId String
  organization   Organization @relation("GymPlans", fields: [organizationId], references: [id])

  memberships  Membership[]
  invoiceItems InvoiceItem[]

  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([organizationId, name])
  @@index([organizationId])
}

model Product {
  id String @id @default(cuid())

  // CAMBIO: SKU ya no es único globalmente (se maneja abajo en @@unique)
  sku         String?
  name        String
  description String?
  price       Decimal      @db.Decimal(10, 2)
  cost        Decimal      @db.Decimal(10, 2)
  stock       Int          @default(0)
  minStock    Int          @default(5)
  type        ProductType
  status      EntityStatus @default(ACTIVE)
  images      String[]

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  invoiceItems InvoiceItem[]

  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // REGLAS APLICADAS:
  // 1. SKU único por organización
  @@unique([sku, organizationId])
  // 2. Name único por organización
  @@unique([name, organizationId])
  @@index([organizationId])
}

model Subscription {
  id                   String             @id @default(cuid())
  status               SubscriptionStatus
  currentPeriodEnd     DateTime
  stripeCustomerId     String?
  stripeSubscriptionId String?            @unique

  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])

  organizationPlanId String
  plan               OrganizationPlan @relation(fields: [organizationPlanId], references: [id])

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model SystemConfig {
  id                 String  @id @default(cuid())
  maintenanceMode    Boolean @default(false)
  globalAnnouncement String?

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model User {
  id String @id @default(cuid())

  // CAMBIO: Quitamos @unique global del email
  email String

  passwordHash String?
  role         Role    @default(STAFF)
  firstName    String?
  lastName     String?
  image        String?

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // REGLA APLICADA: Email único por organización
  // Nota: Esto permite tener el mismo email en diferentes gyms (o sin gym si orgId es null)
  @@unique([email, organizationId])
  @@index([organizationId])
}

// --------------------------------------
// ENUMS (Sin cambios)
// --------------------------------------

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  INCOMPLETE
}

enum Role {
  GOD
  OWNER
  ADMIN
  STAFF
  TRAINER
}

enum DocType {
  DNI
  CE
  PASSPORT
  RUC
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ProductType {
  CONSUMABLE
  GEAR
  MERCH
  SERVICE
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
  PENDING
  CANCELLED
}

enum AttendanceMethod {
  QR
  MANUAL
}

enum EntityStatus {
  ACTIVE
  INACTIVE
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  VOID
  OVERDUE
  REFUNDED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  TRANSFER
  YAPE
  PLIN
  STRIPE
}
