generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id                 String           @id @default(cuid())
  name               String
  slug               String           @unique
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  image              String?
  organizationPlanId String
  settings           Json?
  members            Member[]
  memberships        Membership[]
  plan               OrganizationPlan @relation(fields: [organizationPlanId], references: [id])
  plans              Plan[]           @relation("GymPlans")
  products           Product[]
  subscription       Subscription?
  users              User[]
}

model OrganizationPlan {
  id            String         @id @default(cuid())
  name          String         @unique
  slug          String         @unique
  description   String?
  image         String?
  price         Decimal        @default(0) @db.Decimal(10, 2)
  currency      String         @default("USD")
  limits        Json
  stripePriceId String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  organizations Organization[]
  subscriptions Subscription[]
}

model Subscription {
  id                   String             @id @default(cuid())
  organizationId       String             @unique
  organizationPlanId   String
  stripeCustomerId     String?
  stripeSubscriptionId String?            @unique
  status               SubscriptionStatus
  currentPeriodEnd     DateTime
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  organization         Organization       @relation(fields: [organizationId], references: [id])
  plan                 OrganizationPlan   @relation(fields: [organizationPlanId], references: [id])
}

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  passwordHash   String?
  role           Role          @default(STAFF)
  organizationId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  image          String?
  isActive       Boolean       @default(true)
  firstName      String?
  lastName       String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

model Member {
  id             String       @id @default(cuid())
  firstName      String
  lastName       String
  email          String?
  phone          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  docNumber      String
  birthDate      DateTime?    @db.Date
  docType        DocType
  gender         Gender?
  organizationId String
  isActive       Boolean      @default(true)
  height         Float?
  image          String?
  imc            Float?
  weight         Float?
  deletedAt      DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id])
  memberships    Membership[]

  @@unique([docType, docNumber, organizationId])
  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([lastName, firstName])
}

model Plan {
  id             String       @id @default(cuid())
  name           String
  description    String?
  price          Decimal      @db.Decimal(10, 2)
  durationDays   Int
  organizationId String
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  image          String?
  memberships    Membership[]
  organization   Organization @relation("GymPlans", fields: [organizationId], references: [id])

  @@index([organizationId])
}

model Membership {
  id             String           @id @default(cuid())
  startDate      DateTime
  endDate        DateTime
  status         MembershipStatus @default(PENDING)
  pricePaid      Decimal          @db.Decimal(10, 2)
  memberId       String
  planId         String
  organizationId String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  member         Member           @relation(fields: [memberId], references: [id])
  organization   Organization     @relation(fields: [organizationId], references: [id])
  plan           Plan             @relation(fields: [planId], references: [id])

  @@index([organizationId])
  @@index([memberId])
  @@index([status])
  @@index([endDate])
}

model Product {
  id             String       @id @default(cuid())
  sku            String?
  name           String
  description    String?
  price          Decimal      @db.Decimal(10, 2)
  cost           Decimal      @db.Decimal(10, 2)
  stock          Int          @default(0)
  minStock       Int          @default(5)
  type           ProductType
  isActive       Boolean      @default(true)
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  images         String[]
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([sku, organizationId])
  @@index([organizationId])
}

model SystemConfig {
  id                 String   @id @default(cuid())
  maintenanceMode    Boolean  @default(false)
  globalAnnouncement String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  INCOMPLETE
}

enum Role {
  GOD
  OWNER
  ADMIN
  STAFF
  TRAINER
}

enum DocType {
  DNI
  CE
  PASSPORT
  RUC
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ProductType {
  CONSUMABLE
  GEAR
  MERCH
  SERVICE
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
  PENDING
  CANCELLED
}
